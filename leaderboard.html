<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Лидерборд</title>
<link rel="stylesheet" href="style.css">
<style>
/* Общий фон */
body {
  margin: 0;
  padding: 20px;
  font-family: 'Orbitron', sans-serif;
  background: linear-gradient(160deg, #1f2c3a, #2c3e50);
  display: flex;
  flex-direction: column;
  align-items: center;
  min-height: 100vh;
  color: #ecf0f1;
  overflow-x: hidden;
}

h1 {
  font-size: 2.5em;
  margin-bottom: 25px;
  color: #ecf0f1;
  text-shadow: 2px 2px 5px rgba(0,0,0,0.5);
}

/* Контейнер лидерборда */
#leaderboard {
  width: 90%;
  max-width: 900px;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

/* Заголовки */
.table-header {
  display: grid;
  grid-template-columns: 1fr 3fr 2fr 2fr;
  padding: 12px 15px;
  border-radius: 12px;
  background: linear-gradient(145deg, #2980b9, #3498db);
  color: #fff;
  font-weight: bold;
  text-align: center;
  box-shadow: 0 4px 10px rgba(0,0,0,0.4);
}

/* Карточки игроков */
.table-row {
  display: grid;
  grid-template-columns: 1fr 3fr 2fr 2fr;
  padding: 12px 15px;
  border-radius: 12px;
  background: linear-gradient(145deg, #34495e, #3d566e);
  box-shadow: 0 3px 8px rgba(0,0,0,0.3);
  align-items: center;
  transition: transform 0.3s, box-shadow 0.3s, background 0.3s;
  opacity: 0;
  transform: translateY(-20px);
}

/* Анимация появления */
.table-row.show {
  opacity: 1;
  transform: translateY(0);
}

/* Hover эффект */
.table-row:hover {
  transform: translateY(-3px) scale(1.02);
  box-shadow: 0 6px 16px rgba(0,0,0,0.35);
  background: linear-gradient(145deg, #3d566e, #4a6a82);
}

/* Текущий игрок */
.current {
  border-left: 5px solid #8e44ad;
  animation: pulse 1.5s infinite;
}

/* Pulse анимация */
@keyframes pulse {
  0% { box-shadow: 0 0 0px rgba(142,68,173,0.5); }
  50% { box-shadow: 0 0 15px rgba(142,68,173,0.8); }
  100% { box-shadow: 0 0 0px rgba(142,68,173,0.5); }
}

/* Колонки */
.table-row div {
  text-align: center;
  font-weight: bold;
  font-size: 1.05em;
}

/* Цвета ролей */
.role-player { color: #ecf0f1; }
.role-moderator { color: #f39c12; text-shadow: 0 0 3px #f39c12; }
.role-elder { color: #e74c3c; text-shadow: 0 0 5px #e74c3c; }

/* Адаптив */
@media screen and (max-width: 700px) {
  .table-row, .table-header { grid-template-columns: 1fr 2fr 2fr 2fr; }
}
</style>
</head>
<body>
<h1>Лидерборд</h1>

<div id="leaderboard">
  <div class="table-header">
    <div>Место</div>
    <div>Ник</div>
    <div>Баллы</div>
    <div>Роль</div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
import { getFirestore, collection, query, orderBy, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyB7QbVxGHR7Qm8o8Wzl_wxsCpzMUdS5rws",
  authDomain: "gdboard-add4a.firebaseapp.com",
  projectId: "gdboard-add4a",
  storageBucket: "gdboard-add4a.firebasestorage.app",
  messagingSenderId: "883125028740",
  appId: "1:883125028740:web:c504de4139943b8606bfd1"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const leaderboardDiv = document.getElementById("leaderboard");

onAuthStateChanged(auth, async (user) => {
  if (!user) return window.location.href = "index.html";

  const userSnap = await getDoc(doc(db, "users", user.uid));
  if (!userSnap.exists()) return window.location.href = "index.html";

  const currentData = userSnap.data();
  if (currentData.role === "player" && currentData.situation !== "verified") return window.location.href = "nick.html";

  const usersRef = collection(db, "users");
  const q = query(usersRef, orderBy("points", "desc"));
  const snapshot = await getDocs(q);

  const usersArray = snapshot.docs.map(docItem => ({ id: docItem.id, ...docItem.data() }));

  // Вычисляем ранги с одинаковыми баллами
  let prevPoints = null;
  let prevRank = 0;
  let skip = 1;

  usersArray.forEach((userData, index) => {
    const points = userData.points || 0;
    if (prevPoints === null || points < prevPoints) {
      prevRank += skip;
      skip = 1;
    } else {
      skip++;
    }
    prevPoints = points;

    // Игроки без верификации и обычные не показываем
    if (userData.situation !== "verified" && userData.role === "player") return;

    const row = document.createElement("div");
    row.classList.add("table-row");
    setTimeout(() => row.classList.add("show"), index * 100); // анимация появления с задержкой
    if (userData.id === user.uid) row.classList.add("current");

    const roleClass = userData.role === "elder" ? "role-elder" : userData.role === "moderator" ? "role-moderator" : "role-player";

    row.innerHTML = `
      <div>${prevRank}</div>
      <div>${userData.nick || "Не указан"}</div>
      <div>${points}</div>
      <div class="${roleClass}">${userData.role === "elder" ? "Старший модер" : userData.role === "moderator" ? "Модер" : "Игрок"}</div>
    `;
    leaderboardDiv.appendChild(row);
  });
});
</script>
</body>
</html>
