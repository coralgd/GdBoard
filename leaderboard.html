<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Лидерборд</title>
<link rel="stylesheet" href="style.css">
<style>
/* Общий фон: темный техногенный с градиентом и subtle линиями */
body {
  margin: 0;
  padding: 20px;
  font-family: 'Orbitron', sans-serif;
  background: linear-gradient(160deg, #0d1117, #121820);
  display: flex;
  flex-direction: column;
  align-items: center;
  min-height: 100vh;
  color: #ecf0f1;
  overflow-x: hidden;
}

/* Заголовок */
h1 {
  font-size: 2.5em;
  margin-bottom: 25px;
  color: #00d1ff;
  text-shadow: 0 0 8px #00d1ff, 0 0 15px #00a8cc;
}

/* Контейнер лидерборда */
#leaderboard {
  width: 90%;
  max-width: 1000px;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

/* Заголовки колонок */
.table-header {
  display: grid;
  grid-template-columns: 1fr 3fr 2fr 2fr;
  padding: 12px 15px;
  border-radius: 10px;
  background: linear-gradient(145deg, #0a1926, #0f2a3f);
  color: #00d1ff;
  font-weight: bold;
  text-align: center;
  box-shadow: 0 4px 12px rgba(0,212,255,0.5);
  border: 1px solid rgba(0,212,255,0.3);
}

/* Карточка игрока */
.table-row {
  display: grid;
  grid-template-columns: 1fr 3fr 2fr 2fr;
  padding: 12px 15px;
  border-radius: 10px;
  background: linear-gradient(145deg, #0f1c2c, #122134);
  border: 1px solid rgba(0,212,255,0.2);
  box-shadow: 0 2px 8px rgba(0,212,255,0.2);
  align-items: center;
  transition: transform 0.3s, box-shadow 0.3s, background 0.3s;
  opacity: 0;
  transform: translateY(-20px);
}

/* Анимация появления */
.table-row.show {
  opacity: 1;
  transform: translateY(0);
}

/* Hover эффект */
.table-row:hover {
  transform: translateY(-3px) scale(1.02);
  box-shadow: 0 6px 20px rgba(0,212,255,0.6), 0 0 15px rgba(0,212,255,0.3) inset;
  background: linear-gradient(145deg, #11263c, #163151);
}

/* Текущий игрок */
.current {
  border-left: 5px solid #00d1ff;
  animation: pulse 1.5s infinite;
}

/* Pulse анимация */
@keyframes pulse {
  0% { box-shadow: 0 0 5px rgba(0,209,255,0.5); }
  50% { box-shadow: 0 0 20px rgba(0,209,255,0.9); }
  100% { box-shadow: 0 0 5px rgba(0,209,255,0.5); }
}

/* Колонки */
.table-row div {
  text-align: center;
  font-weight: bold;
  font-size: 1.05em;
  position: relative;
}

/* Топ-3 градиенты мест */
.table-row.top1 { background: linear-gradient(145deg, #ffd700, #e6c200); color:#000; }
.table-row.top2 { background: linear-gradient(145deg, #c0c0c0, #a6a6a6); color:#000; }
.table-row.top3 { background: linear-gradient(145deg, #cd7f32, #b36b2e); color:#000; }

/* Цвета ролей с неоновым glow */
.role-player { color: #ecf0f1; }
.role-moderator { color: #f39c12; text-shadow: 0 0 6px #f39c12, 0 0 12px #f39c12; }
.role-elder { color: #e74c3c; text-shadow: 0 0 8px #e74c3c, 0 0 15px #e74c3c; }

/* Адаптив */
@media screen and (max-width: 700px) {
  .table-row, .table-header { grid-template-columns: 1fr 2fr 2fr 2fr; }
}
</style>
</head>
<body>
<h1>Лидерборд</h1>

<div id="leaderboard">
  <div class="table-header">
    <div>Место</div>
    <div>Ник</div>
    <div>Баллы</div>
    <div>Роль</div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
import { getFirestore, collection, query, orderBy, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyB7QbVxGHR7Qm8o8Wzl_wxsCpzMUdS5rws",
  authDomain: "gdboard-add4a.firebaseapp.com",
  projectId: "gdboard-add4a",
  storageBucket: "gdboard-add4a.firebasestorage.app",
  messagingSenderId: "883125028740",
  appId: "1:883125028740:web:c504de4139943b8606bfd1"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const leaderboardDiv = document.getElementById("leaderboard");

onAuthStateChanged(auth, async (user) => {
  if (!user) return window.location.href = "index.html";

  const userSnap = await getDoc(doc(db, "users", user.uid));
  if (!userSnap.exists()) return window.location.href = "index.html";

  const currentData = userSnap.data();
  if (currentData.role === "player" && currentData.situation !== "verified") return window.location.href = "nick.html";

  const usersRef = collection(db, "users");
  const q = query(usersRef, orderBy("points", "desc"));
  const snapshot = await getDocs(q);

  const usersArray = snapshot.docs.map(docItem => ({ id: docItem.id, ...docItem.data() }));

  // Вычисляем ранги с одинаковыми баллами
  let prevPoints = null;
  let prevRank = 0;
  let skip = 1;

  usersArray.forEach((userData, index) => {
    const points = userData.points || 0;
    if (prevPoints === null || points < prevPoints) {
      prevRank += skip;
      skip = 1;
    } else {
      skip++;
    }
    prevPoints = points;

    // Игроки без верификации и обычные не показываем
    if (userData.situation !== "verified" && userData.role === "player") return;

    const row = document.createElement("div");
    row.classList.add("table-row");
    setTimeout(() => row.classList.add("show"), index * 100);

    if (userData.id === user.uid) row.classList.add("current");

    // Топ-3 места
    if(prevRank===1) row.classList.add("top1");
    else if(prevRank===2) row.classList.add("top2");
    else if(prevRank===3) row.classList.add("top3");

    const roleClass = userData.role === "elder" ? "role-elder" : userData.role === "moderator" ? "role-moderator" : "role-player";

    row.innerHTML = `
      <div>${prevRank}</div>
      <div>${userData.nick || "Не указан"}</div>
      <div>${points}</div>
      <div class="${roleClass}">${userData.role === "elder" ? "Старший модер" : userData.role === "moderator" ? "Модер" : "Игрок"}</div>
    `;
    leaderboardDiv.appendChild(row);
  });
});
</script>
</body>
</html>
